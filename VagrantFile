# -*- mode: ruby -*-
# vi: set ft=ruby :
ENV['VAGRANT_DEFAULT_PROVIDER'] = 'virtualbox'

services = {
    "pe-master"     => "debian-73-x64-virtualbox-nocm",
    "pe-puppetdb"   => "debian-73-x64-virtualbox-nocm",
    "pe-console"    => "debian-73-x64-virtualbox-nocm",
    "pe-monolithic" => "debian-73-x64-virtualbox-nocm",
    "pe-kermit"  => "debian-73-x64-virtualbox-pe301",
}

agents   = {
  "pe-agent"   => "debian-73-x64-virtualbox-nocm",
  "pe-centos6" => "centos-65-x64-virtualbox-nocm",
}

public_key = File.read(File.expand_path('~/.ssh/authorized_keys'))
bashrc = File.read(File.expand_path('./files/.bashrc'))

ssh_provisioner = <<PROVISION
mkdir -p ~/.ssh
cat <<PUBLIC_KEY > ~/.ssh/authorized_keys
#{public_key}
PUBLIC_KEY
PROVISION

bashrc_provisioner= <<PROVISION
cat <<BASHRC > ~/.bashrc
#{bashrc}
BASHRC
PROVISION


Vagrant.configure("2") do |config|

    services.each_with_index do |(name, box), idx|
      config.vm.define name do |service_config|
          service_config.vm.box_url = "http://puppet-vagrant-boxes.puppetlabs.com/#{box}.box"
          service_config.vm.box = box

          ip = "172.16.1.#{110 + idx}"
          service_config.vm.network :private_network, :ip => ip
          service_config.vm.hostname = "#{name}.aroetker.lan"

          service_config.vm.provider :virtualbox do |vb|
              vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
              vb.customize ['modifyvm', :id, '--memory', 2048]
          end

          service_config.vm.provision :shell, :inline => ssh_provisioner
          service_config.vm.provision :shell, :inline => bashrc_provisioner
          service_config.vm.provision :shell, :inline => <<PROVISION
apt-get update && apt-get install vim tree dpkg-dev -y
echo 'APT::Get::AllowUnauthenticated "true";' > /etc/apt/apt.conf.d/90unauthenticated
sed -i -e 's/#{ip}//' -e 's/#{name}.aroetker.lan//' -e 's/#{name}//' /etc/hosts
echo "#{ip} #{name}.aroetker.lan #{name}" >> /etc/hosts
PROVISION
      end
    end

  agents.each_with_index do |(name, box), idx|
    config.vm.define name do |agent_config|
      agent_config.vm.box_url = "http://puppet-vagrant-boxes.puppetlabs.com/#{box}.box"
      agent_config.vm.box = box

      ip = "172.16.1.#{100 + idx + 1}"
      agent_config.vm.network :private_network, :ip => ip
      agent_config.vm.hostname = "#{name}.aroetker.lan"

      agent_config.vm.provider :virtualbox do |vb|
        vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
      end

      agent_config.vm.provision :shell, :inline => ssh_provisioner
      agent_config.vm.provision :shell, :inline => <<PROVISION
sed -i -e 's/#{name}.aroetker.lan//' -e 's/#{name}//' /etc/hosts
echo "#{ip} #{name}.aroetker.lan #{name}" >> /etc/hosts
PROVISION
    end
  end
end
